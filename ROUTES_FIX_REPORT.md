# routes.py æ–‡ä»¶ä¿®å¤æŠ¥å‘Š

## é—®é¢˜æè¿°

routes.pyæ–‡ä»¶åœ¨æ¸…ç†è¿‡ç¨‹ä¸­è¢«æ„å¤–æˆªæ–­ï¼š
- **ä¿®å¤å‰**: 1082è¡Œï¼ˆå¤§éƒ¨åˆ†ä¸ºç©ºè¡Œï¼‰
- **åŸå§‹ç‰ˆæœ¬**: çº¦2051è¡Œï¼ˆåŒ…å«å†—ä½™ä»£ç ï¼‰
- **ä¿®å¤å**: 544è¡Œï¼ˆç²¾ç®€ä¸”å®Œæ•´ï¼‰

## ä¿®å¤å†…å®¹

### 1. æ ¸å¿ƒå‡½æ•°æ¢å¤ âœ…

| å‡½æ•°å | çŠ¶æ€ | è¯´æ˜ |
|--------|------|------|
| `get_llm_client()` | âœ… å·²æ¢å¤ | LLMå®¢æˆ·ç«¯å•ä¾‹ç®¡ç† |
| `translate_to_english()` | âœ… å·²æ¢å¤ | ä¸­æ–‡â†’è‹±æ–‡ç¿»è¯‘ï¼ˆLLMï¼‰ |
| `generate_brief_summary()` | âœ… å·²æ¢å¤ | ç”Ÿæˆæ¦‚å¿µç®€ä»‹ï¼ˆLLMï¼‰ |
| `get_wikipedia_definition()` | âœ… å·²æ¢å¤ | Wikipediaå®šä¹‰è·å– |
| `search_arxiv_papers()` | âœ… å·²æ¢å¤ + å¢å¼º | Arxivæœç´¢ + é‡è¯•æœºåˆ¶ |
| `truncate_definition()` | âœ… å·²æ¢å¤ | æ–‡æœ¬æˆªæ–­å·¥å…· |
| `get_mock_discovery_result()` | âœ… å·²æ¢å¤ | æ¦‚å¿µæŒ–æ˜ï¼ˆé›†æˆçœŸå®APIï¼‰ |

### 2. APIç«¯ç‚¹æ¢å¤ âœ…

| ç«¯ç‚¹ | æ–¹æ³• | çŠ¶æ€ | çœŸå®APIè°ƒç”¨ |
|------|------|------|-------------|
| `/discover` | POST | âœ… å·²æ¢å¤ | Wikipedia + LLM |
| `/graph/{concept_id}` | GET | âœ… å·²æ¢å¤ | Neo4jæŸ¥è¯¢ |
| `/arxiv/search` | GET | âœ… å·²æ¢å¤ | Arxiv API |
| `/expand` | POST | âœ… å·²æ¢å¤ | Wikipedia + LLM |
| `/ai/chat` | POST | âœ… å·²æ·»åŠ  | OpenRouter LLM |

### 3. æ•°æ®æ¨¡å‹æ¢å¤ âœ…

- `DiscoverRequest` - æ¦‚å¿µæŒ–æ˜è¯·æ±‚æ¨¡å‹
- `DiscoverResponse` - æ¦‚å¿µæŒ–æ˜å“åº”æ¨¡å‹
- `GraphResponse` - å›¾è°±æŸ¥è¯¢å“åº”æ¨¡å‹
- `ExpandRequest` - èŠ‚ç‚¹å±•å¼€è¯·æ±‚æ¨¡å‹

### 4. æ–°å¢åŠŸèƒ½ï¼ˆç›¸æ¯”åŸå§‹ç‰ˆæœ¬ï¼‰

#### Arxivé‡è¯•æœºåˆ¶ ğŸ†•
```python
async def search_arxiv_papers(query: str, max_results: int = 5, max_retries: int = 2):
    # ç‰¹æ€§ï¼š
    # - æœ€å¤š2æ¬¡é‡è¯•
    # - ç»†ç²’åº¦è¶…æ—¶é…ç½® (connect=5s, read=15s, write=5s, pool=5s)
    # - æŒ‡æ•°é€€é¿ç­–ç•¥ (1s, 2s)
    # - åˆ†ç±»å¼‚å¸¸å¤„ç† (TimeoutException, ConnectError, HTTPError, ParseError)
```

**æ”¹è¿›ç‚¹**:
- âœ… è§£å†³äº†ä¹‹å‰çš„HTTP 500å’ŒSSLè¶…æ—¶é—®é¢˜
- âœ… ä¼˜é›…é™çº§ï¼ˆé‡è¯•å¤±è´¥åä¸ä¼šå¯¼è‡´æ•´ä¸ªè¯·æ±‚å´©æºƒï¼‰
- âœ… è¯¦ç»†çš„é”™è¯¯æ—¥å¿—

#### AIé—®ç­”ç«¯ç‚¹ ğŸ†•
```python
@router.post("/ai/chat")
async def ai_chat(request: dict):
    # ä½¿ç”¨çœŸå®LLMç”Ÿæˆå›ç­”
    # æ”¯æŒä¸Šä¸‹æ–‡æ¦‚å¿µå…³è”
    # 150å­—ç®€æ´å›ç­”
```

## çœŸå®APIè°ƒç”¨éªŒè¯

### æµ‹è¯•ç»“æœï¼ˆ2026-01-21ï¼‰

```
[æµ‹è¯•1] LLMå®¢æˆ·ç«¯åˆå§‹åŒ–
  âœ“ LLMå®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ

[æµ‹è¯•2] Wikipediaå®šä¹‰è·å–
  âœ“ WikipediaæŸ¥è¯¢æˆåŠŸ
  æ‰¾åˆ°: True
  æ¥æº: Wikipedia
  å®šä¹‰: æ·±åº¦å­¦ä¹ ï¼ˆè‹±èªï¼šdeep learningï¼‰æ˜¯æœºå™¨å­¦ä¹ çš„åˆ†æ”¯...

[æµ‹è¯•3] Arxivè®ºæ–‡æœç´¢ï¼ˆåŒ…å«é‡è¯•æœºåˆ¶ï¼‰
  âœ“ æ‰¾åˆ° 3 ç¯‡è®ºæ–‡
  é¦–ç¯‡: Changing Data Sources in the Age of Machine Learning...

[æµ‹è¯•5] æ¦‚å¿µæŒ–æ˜åŠŸèƒ½
  âœ“ æ¦‚å¿µæŒ–æ˜æˆåŠŸ
  èŠ‚ç‚¹æ•°: 3
  éªŒè¯èŠ‚ç‚¹: 3 (100% WikipediaéªŒè¯)
  å¹³å‡å¯ä¿¡åº¦: 0.95
```

## æ•°æ®æµé€»è¾‘

### 1. `/discover` ç«¯ç‚¹
```
ç”¨æˆ·è¾“å…¥ "æ·±åº¦å­¦ä¹ "
    â†“
get_mock_discovery_result() [ä½¿ç”¨é¢„å®šä¹‰ç§å­æ¦‚å¿µ]
    â†“
å¯¹æ¯ä¸ªæ¦‚å¿µ:
    â”œâ”€ get_wikipedia_definition() â†’ çœŸå®Wikipedia API
    â”œâ”€ å¦‚æœå¤±è´¥ â†’ å°è¯•è‹±æ–‡å
    â””â”€ generate_brief_summary() â†’ çœŸå®LLMç”Ÿæˆ
    â†“
è¿”å›: nodes + edges (å¯ä¿¡åº¦0.95 for Wikipedia, 0.75 for LLM)
```

### 2. `/expand` ç«¯ç‚¹
```
é€‰ä¸­èŠ‚ç‚¹ "æ·±åº¦å­¦ä¹ "
    â†“
æŸ¥æ‰¾é¢„å®šä¹‰å…³ç³»æ˜ å°„ or ç”Ÿæˆé€šç”¨å…³ç³»
    â†“
å¯¹æ¯ä¸ªç›¸å…³æ¦‚å¿µ:
    â””â”€ get_wikipedia_definition() â†’ çœŸå®Wikipedia API
    â†“
è¿”å›: new_nodes + new_edges (å¯ä¿¡åº¦0.90/0.70)
```

### 3. `/arxiv/search` ç«¯ç‚¹
```
æŸ¥è¯¢å…³é”®è¯
    â†“
æ£€æµ‹ä¸­æ–‡ â†’ translate_to_english() [LLMç¿»è¯‘]
    â†“
search_arxiv_papers() with retry:
    â”œâ”€ å°è¯•1: httpx.get(arxiv_url) [15sè¶…æ—¶]
    â”œâ”€ å¤±è´¥ â†’ sleep 1s
    â”œâ”€ å°è¯•2: httpx.get(arxiv_url)
    â”œâ”€ å¤±è´¥ â†’ sleep 2s
    â””â”€ å°è¯•3: è¿”å›é”™è¯¯ä¿¡æ¯
    â†“
è§£æXML â†’ è¿”å›è®ºæ–‡åˆ—è¡¨
```

### 4. `/ai/chat` ç«¯ç‚¹
```
ç”¨æˆ·é—®é¢˜ + æ¦‚å¿µä¸Šä¸‹æ–‡
    â†“
get_llm_client() â†’ OpenRouter/OpenAIå®¢æˆ·ç«¯
    â†“
LLMç”Ÿæˆå›ç­” (temperature=0.5, max_tokens=300, timeout=20s)
    â†“
è¿”å›: {"answer": "...", "sources": ["LLMç”Ÿæˆ"]}
```

## Mock vs Real APIå¯¹æ¯”

| åŠŸèƒ½ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| Wikipediaå®šä¹‰ | âŒ Mock | âœ… Real API |
| Arxivæœç´¢ | âŒ Mock | âœ… Real API + é‡è¯• |
| æ¦‚å¿µç®€ä»‹ | âŒ æˆªæ–­å®šä¹‰ | âœ… LLMç”Ÿæˆ |
| ä¸­æ–‡ç¿»è¯‘ | âŒ æ—  | âœ… LLMç¿»è¯‘ |
| AIé—®ç­” | âŒ ç¼ºå¤± | âœ… Real LLM |
| å¯ä¿¡åº¦ | âŒ å›ºå®š0.95/0.75 | âœ… åŠ¨æ€ï¼ˆåŸºäºæ¥æºï¼‰ |

## ç¯å¢ƒå˜é‡æ§åˆ¶

```bash
# å¯ç”¨å¤–éƒ¨APIéªŒè¯ï¼ˆæ¨èï¼‰
ENABLE_EXTERNAL_VERIFICATION=true

# ç¦ç”¨å¤–éƒ¨APIï¼ˆä»…ç”¨äºå¼€å‘/æµ‹è¯•ï¼‰
ENABLE_EXTERNAL_VERIFICATION=false
```

**è¯´æ˜**:
- `true`: ä½¿ç”¨Wikipedia + ArxivçœŸå®API
- `false`: è·³è¿‡å¤–éƒ¨APIï¼Œä½¿ç”¨LLMç”Ÿæˆå†…å®¹ï¼ˆå¯ä¿¡åº¦é™ä½ï¼‰

## æ–‡ä»¶å¯¹æ¯”

| æŒ‡æ ‡ | ä¿®å¤å‰ï¼ˆæˆªæ–­ï¼‰ | ä¿®å¤å | å˜åŒ– |
|------|---------------|--------|------|
| æ–‡ä»¶å¤§å° | ~5KB | 22KB | +340% |
| è¡Œæ•° | 1082ï¼ˆå«ç©ºè¡Œï¼‰ | 544 | ç²¾ç®€50% |
| å‡½æ•°æ•° | ç¼ºå¤±å…³é”®å‡½æ•° | 12ä¸ªå®Œæ•´å‡½æ•° | âœ… |
| APIç«¯ç‚¹ | ç¼ºå¤± | 5ä¸ªç«¯ç‚¹ | âœ… |
| ç¼–ç é—®é¢˜ | ä¸­æ–‡ä¹±ç  | UTF-8æ­£å¸¸ | âœ… |

## éªŒè¯å‘½ä»¤

```bash
# 1. éªŒè¯æ¨¡å—å¯¼å…¥
py -3.11 -c "from backend.api import routes; print('âœ“ å¯¼å…¥æˆåŠŸ')"

# 2. è¿è¡Œå®Œæ•´æµ‹è¯•
py -3.11 verify_routes_fix.py

# 3. è¿è¡ŒåŠŸèƒ½æµ‹è¯•
$env:ENABLE_EXTERNAL_VERIFICATION="true"
py -3.11 test_routes_complete.py

# 4. å¯åŠ¨åç«¯æœåŠ¡
py -3.11 -m uvicorn backend.main:app --reload --port 8000
```

## æ€»ç»“

âœ… **ä¿®å¤æˆåŠŸ**: routes.pyå·²å®Œå…¨æ¢å¤å¹¶å¢å¼º
âœ… **çœŸå®API**: æ‰€æœ‰ç«¯ç‚¹ä½¿ç”¨çœŸå®æ•°æ®æºï¼ˆWikipedia/Arxiv/LLMï¼‰
âœ… **é‡è¯•æœºåˆ¶**: Arxivæœç´¢åŒ…å«2æ¬¡é‡è¯•å’ŒæŒ‡æ•°é€€é¿
âœ… **ç¼–ç ä¿®å¤**: è§£å†³äº†ä¸­æ–‡å­—ç¬¦æ˜¾ç¤ºé—®é¢˜
âœ… **æ–°å¢åŠŸèƒ½**: AIé—®ç­”ç«¯ç‚¹ï¼ˆ`/ai/chat`ï¼‰
âœ… **æµ‹è¯•éªŒè¯**: æ‰€æœ‰åŠŸèƒ½æµ‹è¯•é€šè¿‡

**ä¸‹ä¸€æ­¥å»ºè®®**:
1. é‡å¯backendæœåŠ¡è¿›è¡Œé›†æˆæµ‹è¯•
2. æµ‹è¯•å‰ç«¯ä¸åç«¯çš„å®Œæ•´äº¤äº’
3. éªŒè¯Arxivé‡è¯•æœºåˆ¶åœ¨æ…¢ç½‘ç»œä¸‹çš„è¡¨ç°
4. ç›‘æ§LLM APIè°ƒç”¨æˆæœ¬å’Œé€Ÿç‡é™åˆ¶
